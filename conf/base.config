/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ebi-metagenomics/mgnifams Nextflow base config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    A 'blank slate' config file, appropriate for general use on most high performance
    compute environments. Assumes that all software is installed and available on
    the PATH. Runs in `local` mode - all jobs will be run on the logged in environment.
----------------------------------------------------------------------------------------
*/

process {

    cpus   = { 1      * task.attempt }
    memory = { 6.GB   * task.attempt }
    time   = { 4.h    * task.attempt }

    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific resource requirements
    // NOTE - Please try and reuse the labels below as much as possible.
    //        These labels are used and recognised by default in DSL2 files hosted on nf-core/modules.
    //        If possible, it would be nice to keep the same label naming convention when
    //        adding in your local modules too.
    // See https://www.nextflow.io/docs/latest/config.html#config-process-selectors
    withLabel:process_single {
        cpus   = { 1                   }
        memory = { 6.GB * task.attempt }
        time   = { 4.h  * task.attempt }
    }
    withLabel:process_low {
        cpus   = { 2     * task.attempt }
        memory = { 12.GB * task.attempt }
        time   = { 4.h   * task.attempt }
    }
    withLabel:process_medium {
        cpus   = { 6     * task.attempt }
        memory = { 36.GB * task.attempt }
        time   = { 8.h   * task.attempt }
    }
    withLabel:process_high {
        cpus   = { 12    * task.attempt }
        memory = { 72.GB * task.attempt }
        time   = { 16.h  * task.attempt }
    }
    withLabel:process_long {
        time   = { 20.h  * task.attempt }
    }
    withLabel:process_high_memory {
        memory = { 200.GB * task.attempt }
    }
    withLabel:error_ignore {
        errorStrategy = 'ignore'
    }
    withLabel:error_retry {
        errorStrategy = 'retry'
        maxRetries    = 2
    }

    withLabel: venv    { memory = '6.0 GB'; time = '10m' }    
    withLabel: general { memory = '100.0 MB'; time = '1m' }

    // SETUP_CLUSTERS
    // extract_unannotated_fasta
    withName: PIGZ_UNCOMPRESS            { cpus = 8; memory = '50.0 MB'; time = '5h' }
    withName: BZ2_UNCOMPRESS             { memory = '50.0 MB'; time = '5h' }
    withName: EXTRACT_UNANNOTATED_SLICES { memory = '60.0 MB'; time = '1h' }
    // execute_clustering
    withName: MMSEQS_CREATEDB            { memory = '40.0 GB'; time = '1h' }
    withName: MMSEQS_LINCLUST            { cpus = 8; memory = '260.0 GB'; time = '3h' }
    withName: MMSEQS_CREATETSV           { cpus = 2; memory = '65.0 GB'; time = '20m' }

    // GENERATE_NONREDUNDANT_FAMILIES
    // generate_families_parallel
    withName: CHUNK_CLUSTERS                       { memory = '100.0 GB'; time = '1h' } // ~32.0MB * num_cluster_chunks
    withName: REFINE_FAMILIES_PARALLEL             { cpus = 4; memory = '350.0 GB'; time = '50h' }
    // flag_transmembrane
    withName: EXTRACT_FIRST_STOCKHOLM_SEQUENCES    { memory = '20.0 GB'; time = '24h' }
    withName: DEEPTMHMM                            { memory = '100.0 MB'; time = '24h' }
    withName: FLAG_TM                              { memory = '40.0 MB'; time = '20m' }
    // remove_redundancy
    withName: MOVE_TO_DIR                          { memory = '20.0 MB'; time = '10m' }
    withName: HHSUITE_BUILDHHDB                    { cpus = 8; memory = '6.0 GB'; time = '2h' }
    withName: HHSUITE_HHBLITS                      { cpus = 8; memory = '5.0 GB'; time = '48h' }
    withName: COMBINE_HH_RESULTS                   { memory = '100.0 MB'; time = '1h' }
    withName: MAP_FIRST_A3M_SEQUENCES_TO_FAMILY_ID { memory = '200.0 MB'; time = '1h' }
    withName: POOL_FAM_PROTEINS                    { memory = '20.0 MB'; time = '10m' }
    withName: REMOVE_REDUNDANT_AND_TM              { memory = '200.0 GB'; time = '72h' }
    withName: POOL_FAMILY_RESULTS                  { memory = '200.0 MB'; time = '24h' }

    // ANNOTATE_FAMILIES
    // reformat_msa
    withName: TRANSLATE_MSA_MGYPS                           { memory = '1.0 GB'; time = '30h' }
    // annotate_models
    withName: HHSUITE_REFORMAT                              { memory = '10.0 GB'; time = '32h' }
    withName: HHSUITE_HHSEARCH                              { cpus = 8; memory = '50.0 MB'; time = '1h' }
    withName: FILTER_HH_RESULTS                             { memory = '50.0 MB'; time = '1h' }
    // predict_structures
    withName: EXTRACT_FIRST_STOCKHOLM_SEQUENCES_FROM_FOLDER { memory = '16.0 GB'; time = '12h' }
    withName: ESMFOLD                                       { memory = '30.0 GB'; time = '4h' }
    withName: ESMFOLD_CPU                                   { cpus = 16; memory = '400.0 GB'; time = '72h' }
    // annotate_structures
    withName: FOLDSEEK_EASYSEARCH                           { cpus = 4; memory = '900.0 GB'; time = '24h' }
    withName: FIND_ANNOTATED_FAMILIES_BY_STRUCTURE          { memory = '100.0 GB'; time = '24h' }

    // EXPORT_DATA
    withName: EXPORT_MGNIFAMS_CSV { memory = '200.0 MB'; time = '10h' }
    withName: QUERY_MGNPROTEIN_DB { memory = '10.0 GB'; time = '72h' }
    withName: PARSE_BIOMES        { memory = '1.0 GB'; time = '6h' }
    withName: PARSE_DOMAINS       { memory = '50.0 GB'; time = '72h' }
    withName: APPEND_SQLITE_BLOBS { memory = '300.0 GB'; time = '120h' }
    
}
